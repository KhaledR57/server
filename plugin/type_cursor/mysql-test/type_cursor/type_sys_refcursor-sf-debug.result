#
# MDEV-20034 Add support for the pre-defined weak SYS_REFCURSOR
#
#
# A cursor on a SELECT returning a local SP variable works in the caller
#
CREATE FUNCTION f1(a INT) RETURNS SYS_REFCURSOR
BEGIN
DECLARE c0 SYS_REFCURSOR;
OPEN c0 FOR SELECT a; 
RETURN c0;
END;
/
CREATE PROCEDURE p2()
BEGIN
DECLARE c0 SYS_REFCURSOR DEFAULT f1(10);
DECLARE v INT;
FETCH c0 INTO v;
SELECT v;
END;
/
CALL p2();
v
10
DROP PROCEDURE p2;
DROP FUNCTION f1;
#
# A function returning on error still clears ref counters
#
# RETURN
CREATE FUNCTION f1() RETURNS SYS_REFCURSOR
BEGIN
DECLARE c0 SYS_REFCURSOR;
DECLARE v INT;
OPEN c0 FOR SELECT 1;
FETCH c0 INTO v;
FETCH c0 INTO v; -- This raises 'No data' error
RETURN c0;
END;
/
CREATE FUNCTION f2() RETURNS SYS_REFCURSOR
BEGIN
DECLARE c0 SYS_REFCURSOR;
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' RETURN NULL; -- Handle 'No data'
  SET c0= f1();
RETURN c0;
END;
/
SELECT f2(), CURSOR_REF_COUNT(0) AS cnt_0, CURSOR_REF_COUNT(1) AS cnt_0;
f2()	cnt_0	cnt_0
NULL	0	NULL
DROP FUNCTION f1;
DROP FUNCTION f2;
# INOUT parameter
CREATE FUNCTION f1(INOUT c0 SYS_REFCURSOR) RETURNS SYS_REFCURSOR
BEGIN
DECLARE v INT;
OPEN c0 FOR SELECT 1;
FETCH c0 INTO v;
FETCH c0 INTO v; -- This raises 'No data' error
RETURN c0;
END;
/
CREATE FUNCTION f2() RETURNS SYS_REFCURSOR
BEGIN
DECLARE c0 SYS_REFCURSOR;
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' RETURN NULL; -- Handle 'No data'
  DO f1(c0);
RETURN c0;
END;
/
SELECT f2(), CURSOR_REF_COUNT(0) AS cnt_0, CURSOR_REF_COUNT(1) AS cnt_0;
f2()	cnt_0	cnt_0
NULL	0	NULL
DROP FUNCTION f1;
DROP FUNCTION f2;
# OUT parameter
CREATE FUNCTION f1(OUT c0 SYS_REFCURSOR) RETURNS SYS_REFCURSOR
BEGIN
DECLARE v INT;
OPEN c0 FOR SELECT 1;
FETCH c0 INTO v;
FETCH c0 INTO v; -- This raises 'No data' error
RETURN c0;
END;
/
CREATE FUNCTION f2() RETURNS SYS_REFCURSOR
BEGIN
DECLARE c0 SYS_REFCURSOR;
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' RETURN NULL; -- Handle 'No data'
  DO f1(c0);
RETURN c0;
END;
/
SELECT f2(), CURSOR_REF_COUNT(0) AS cnt_0, CURSOR_REF_COUNT(1) AS cnt_0;
f2()	cnt_0	cnt_0
NULL	0	NULL
DROP FUNCTION f1;
DROP FUNCTION f2;
