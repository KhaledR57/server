include/rpl_init.inc [topology=1->2->1,1->3,2->4]
connection server_1;
include/stop_slave.inc
CHANGE MASTER TO Master_use_gtid=current_pos;
include/start_slave.inc
connection server_2;
include/stop_slave.inc
CHANGE MASTER TO Master_use_gtid=current_pos;
include/start_slave.inc
connection server_3;
include/stop_slave.inc
CHANGE MASTER TO Master_use_gtid=current_pos;
include/start_slave.inc
connection server_4;
include/stop_slave.inc
CHANGE MASTER TO Master_use_gtid=current_pos;
include/start_slave.inc
connection server_1;
CREATE TABLE t1(a INT PRIMARY KEY, b VARCHAR(10)) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1, 'B0'), (2, 'B1');
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
SELECT * FROM t1 ORDER BY a;
a	b
1	B0
2	B1
connection server_3;
include/sync_with_master_gtid.inc
SELECT * FROM t1 ORDER BY a;
a	b
1	B0
2	B1
connection server_4;
include/sync_with_master_gtid.inc
SELECT * FROM t1 ORDER BY a;
a	b
1	B0
2	B1
connection server_1;
STOP SLAVE IO_THREAD;
include/wait_for_slave_io_to_stop.inc
INSERT INTO t1 VALUES (10, 'E1');
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
INSERT INTO t1 VALUES (12, 'E3');
SELECT * FROM t1 ORDER BY a;
a	b
1	B0
2	B1
10	E1
12	E3
STOP SLAVE IO_THREAD;
include/wait_for_slave_io_to_stop.inc
connection server_1;
INSERT INTO t1 VALUES (11, 'E2');
include/save_master_gtid.inc
connection server_3;
include/sync_with_master_gtid.inc
SELECT * FROM t1 ORDER BY a;
a	b
1	B0
2	B1
10	E1
11	E2
connection server_1;
STOP SLAVE SQL_THREAD;
include/wait_for_slave_sql_to_stop.inc
connection server_3;
include/stop_slave.inc
CHANGE MASTER TO master_host='127.0.0.1',master_port=SERVER_MYPORT_2;
include/start_slave.inc
connection server_2;
STOP SLAVE SQL_THREAD;
include/wait_for_slave_sql_to_stop.inc
CHANGE MASTER TO master_host='127.0.0.1',master_port=SERVER_MYPORT_3;
include/start_slave.inc
connection server_3;
include/sync_with_master_gtid.inc
SELECT * FROM t1 ORDER BY a;
a	b
1	B0
2	B1
10	E1
11	E2
12	E3
connection server_1;
CHANGE MASTER TO master_host='127.0.0.1',master_port=SERVER_MYPORT_3;
include/start_slave.inc
connection server_3;
INSERT INTO t1 VALUES (20, 'S3');
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
INSERT INTO t1 VALUES (21, 'S2');
SELECT * FROM t1 ORDER BY a;
a	b
1	B0
2	B1
10	E1
11	E2
12	E3
20	S3
21	S2
include/save_master_gtid.inc
connection server_1;
include/sync_with_master_gtid.inc
SELECT * FROM t1 ORDER BY a;
a	b
1	B0
2	B1
10	E1
11	E2
12	E3
20	S3
21	S2
connection server_1;
include/stop_slave.inc
CHANGE MASTER TO master_host='127.0.0.1',master_port=SERVER_MYPORT_2;
include/start_slave.inc
connection server_2;
include/stop_slave.inc
CHANGE MASTER TO master_host='127.0.0.1',master_port=SERVER_MYPORT_1;
include/start_slave.inc
connection server_3;
include/stop_slave.inc
CHANGE MASTER TO master_host='127.0.0.1',master_port=SERVER_MYPORT_1;
include/start_slave.inc
connection server_1;
DROP TABLE t1;
include/rpl_end.inc
